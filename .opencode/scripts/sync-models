#!/usr/bin/env bun

/**
 * sync-models
 * 
 * Syncs Ollama models to:
 * - .opencode/opencode.json model providers
 * - models/*.md documentation files
 * 
 * Usage: ./. opencode/scripts/sync-models
 */

import { exec } from "child_process";
import { promisify } from "util";
import { readFileSync, writeFileSync, existsSync } from "fs";
import { join } from "path";

const execAsync = promisify(exec);

const REPO_ROOT = process.cwd();
const OPENCODE_CONFIG = join(REPO_ROOT, ".opencode/opencode.json");
const MODELS_DIR = join(REPO_ROOT, "models");

interface OllamaModel {
  name: string;
  tag: string;
  size: string;
  id: string;
  modified: string;
}

async function getInstalledModels(): Promise<OllamaModel[]> {
  try {
    const { stdout } = await execAsync("ollama list");
    const lines = stdout.trim().split("\n").slice(1); // Skip header
    
    return lines.map((line) => {
      const parts = line.trim().split(/\s+/);
      const [nameTag, id, ...sizeParts] = parts;
      const [name, tag = "latest"] = nameTag.split(":");
      
      // Size is everything after ID until the last 2-3 parts (which are the date)
      const modified = parts.slice(-3).join(" ");
      const size = parts.slice(2, -3).join(" ");
      
      return { name, tag, size, id, modified };
    });
  } catch (error) {
    console.error("Error getting installed models:", error);
    return [];
  }
}

function updateOpenCodeConfig(models: OllamaModel[]) {
  let config: any = {};
  
  if (existsSync(OPENCODE_CONFIG)) {
    config = JSON.parse(readFileSync(OPENCODE_CONFIG, "utf-8"));
  }
  
  if (!config.modelProviders) {
    config.modelProviders = {};
  }
  
  // Add/update model providers for our recommended models
  const recommendedModels = [
    { name: "qwen2.5-coder", tag: "32b", alias: "qwen-coder" },
    { name: "deepseek-r1", tag: "32b", alias: "deepseek-reasoning" },
    { name: "llama3-groq-tool-use", tag: "8b", alias: "groq-tools" },
  ];
  
  for (const rec of recommendedModels) {
    const found = models.find(m => m.name === rec.name && m.tag === rec.tag);
    if (found) {
      config.modelProviders[rec.alias] = {
        provider: "ollama",
        model: `${rec.name}:${rec.tag}`,
        description: getModelDescription(rec.name),
      };
    }
  }
  
  writeFileSync(OPENCODE_CONFIG, JSON.stringify(config, null, 2));
  console.log(`‚úÖ Updated ${OPENCODE_CONFIG}`);
}

function getModelDescription(name: string): string {
  const descriptions: Record<string, string> = {
    "qwen2.5-coder": "Best coding model (HumanEval 79-82%)",
    "deepseek-r1": "Best reasoning model (GSM8K 93.2%)",
    "llama3-groq-tool-use": "Best function calling (BFCL 89%)",
  };
  return descriptions[name] || "Local Ollama model";
}

function normalizeModelName(name: string, tag: string): string {
  // Convert model:tag to filename-friendly format
  return `${name}-${tag}`.replace(/[^a-z0-9-]/gi, "-").replace(/-+/g, "-");
}

async function main() {
  console.log("üîç Scanning installed Ollama models...");
  const models = await getInstalledModels();
  
  if (models.length === 0) {
    console.log("‚ùå No models found. Install models with: ollama pull <model>");
    process.exit(1);
  }
  
  console.log(`üì¶ Found ${models.length} installed models`);
  models.forEach(m => console.log(`   - ${m.name}:${m.tag} (${m.size})`));
  
  console.log("\nüîß Updating OpenCode configuration...");
  updateOpenCodeConfig(models);
  
  console.log("\n‚úÖ Sync complete!");
  console.log("\nModel providers available:");
  const config = JSON.parse(readFileSync(OPENCODE_CONFIG, "utf-8"));
  for (const [alias, provider] of Object.entries(config.modelProviders || {})) {
    console.log(`   ${alias}: ${(provider as any).model}`);
  }
}

main().catch(console.error);
